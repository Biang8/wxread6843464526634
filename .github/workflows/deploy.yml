name: wxread

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶ä»»åŠ¡è§¦å‘æ¡ä»¶
  schedule:
    # æ™šé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 22:00 è§¦å‘ï¼Œè½¬æ¢ä¸º UTC æ—¶é—´æ˜¯ 14:00
    - cron: '0 14 * * *'          # åŒ—äº¬æ—¶é—´ï¼š22:00ï¼ŒUTC æ—¶é—´ï¼š14:00
    # æ—©é—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´å‘¨ä¸€åˆ°å‘¨äº” 05:00 è§¦å‘ï¼Œè½¬æ¢ä¸º UTC æ—¶é—´æ˜¯å‰ä¸€å¤©çš„ 21:00
    - cron: '0 21 * * 0-4'        # åŒ—äº¬æ—¶é—´ï¼š05:00ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰ï¼ŒUTC æ—¶é—´ï¼š21:00ï¼ˆå‘¨æ—¥åˆ°å‘¨å››ï¼‰
    # åˆé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´å‘¨ä¸€åˆ°å‘¨äº” 11:40 è§¦å‘ï¼Œè½¬æ¢ä¸º UTC æ—¶é—´æ˜¯ 03:40
    - cron: '40 3 * * 1-5'        # åŒ—äº¬æ—¶é—´ï¼š11:40ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰ï¼ŒUTC æ—¶é—´ï¼š03:40ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰
    # å‘¨æœ«ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´å‘¨å…­å’Œå‘¨æ—¥ 17:00 è§¦å‘ï¼Œè½¬æ¢ä¸º UTC æ—¶é—´æ˜¯ 09:00
    - cron: '0 9 * * sat,sun'     # åŒ—äº¬æ—¶é—´ï¼š17:00ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ï¼‰ï¼ŒUTC æ—¶é—´ï¼š09:00ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ï¼‰
    # å‘¨éšæœºä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´å‘¨æœ« 08:00 è§¦å‘ï¼Œè½¬æ¢ä¸º UTC æ—¶é—´æ˜¯å‰ä¸€å¤©çš„ 00:00
    - cron: '0 0 * * sat,sun'     # åŒ—äº¬æ—¶é—´ï¼š08:00ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ï¼‰ï¼ŒUTC æ—¶é—´ï¼š00:00ï¼ˆå‘¨äº”å’Œå‘¨å…­ï¼‰
  # æ‰‹åŠ¨è§¦å‘æ¡ä»¶
  workflow_dispatch:
    description: æ‰‹åŠ¨è§¦å‘å¾®ä¿¡é˜…è¯»ä»»åŠ¡
    inputs:
      mode:
        type: choice
        description: |
          é€‰æ‹©è¿è¡Œæ¨¡å¼ï¼š
          - è‡ªåŠ¨ï¼šè‡ªåŠ¨æ¨¡å¼ï¼Œæ ¹æ®ä¸åŒçš„å®šæ—¶ä»»åŠ¡è§„åˆ™ï¼Œç”Ÿæˆç›¸åº”èŒƒå›´å†…çš„éšæœºé˜…è¯»æ—¶é—´ã€‚å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æœªè®¾ç½®è‡ªå®šä¹‰å»¶è¿Ÿï¼Œä¼šæœ‰ 0 - 20 åˆ†é’Ÿçš„éšæœºå»¶è¿Ÿã€‚
          - æ‰‹åŠ¨ï¼šæ‰‹åŠ¨æ¨¡å¼ï¼Œè‹¥æœªè¾“å…¥è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼Œä¼šç”Ÿæˆ 60 - 120ï¼ˆç­‰æ•ˆ 30 - 60 åˆ†é’Ÿï¼‰ä¹‹é—´çš„éšæœºé˜…è¯»æ—¶é—´ï¼›è‹¥è¾“å…¥äº†è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼Œåˆ™ä½¿ç”¨è¯¥æ—¶é—´è®¡ç®—é˜…è¯»æ¬¡æ•°ã€‚
        required: true
        default: 'æ‰‹åŠ¨'
        options:
          - è‡ªåŠ¨
          - æ‰‹åŠ¨
      custom_time:
        type: string
        description: 'æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼Œä»…æ‰‹åŠ¨è§¦å‘æœ‰æ•ˆï¼‰ã€‚è¾“å…¥åï¼Œä¼šå°†è¯¥æ—¶é—´ä¹˜ä»¥ 2 ä½œä¸º READ_NUM ç”¨äºåç»­ä»»åŠ¡ã€‚'
        required: false
      custom_delay:
        type: string
        description: 'æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰å»¶è¿Ÿæ—¶é—´ï¼ˆåˆ†é’Ÿï¼Œä»…æ‰‹åŠ¨è§¦å‘æœ‰æ•ˆï¼‰ã€‚è¾“å…¥åï¼Œä»»åŠ¡ä¼šå»¶è¿Ÿç›¸åº”çš„åˆ†é’Ÿæ•°æ‰§è¡Œã€‚'
        required: false
      debug_schedule:
        type: choice
        description: 'é€‰æ‹©è°ƒè¯•å®šæ—¶ä»»åŠ¡ï¼Œå¼€å¯åæŒ‰æŒ‡å®šä»»åŠ¡æ—¶é—´è¿è¡Œ'
        required: false
        default: 'æ— '
        options:
          - æ— 
          - æ™šé—´ä»»åŠ¡
          - æ—©é—´ä»»åŠ¡
          - åˆé—´ä»»åŠ¡
          - å‘¨æœ«ä»»åŠ¡
          - å‘¨éšæœºä»»åŠ¡

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead
    outputs:
      week_random_skipped: ${{ steps.week_random_check.outputs.skipped }}

    steps:
    - name: ğŸ”§ è®¾ç½® DNS
      run: |
        # é…ç½®ä¸» DNS æœåŠ¡å™¨ä¸º Google çš„å…¬å…± DNS
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        # é…ç½®å¤‡ç”¨ DNS æœåŠ¡å™¨ä¸º Google çš„å…¬å…± DNS
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "âœ… DNS é…ç½®å®Œæˆ"

    - name: ğŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½® Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        echo "::group::ğŸ“¦ å®‰è£…ä¾èµ–"
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        pip list  # æ˜¾ç¤ºå®‰è£…çš„ä¾èµ–
        echo "::endgroup::"
        # éªŒè¯ requests åº“æ˜¯å¦å®‰è£…æˆåŠŸ
        echo "âœ… ä¾èµ–å®‰è£…éªŒè¯ï¼š$(pip list | grep requests)"

    - name: â±ï¸ éšæœºå»¶è¿Ÿï¼ˆè‡ªåŠ¨æ¨¡å¼æˆ–è®¡åˆ’æ¨¡å¼æˆ–æ‰‹åŠ¨è§¦å‘è°ƒè¯•æ¨¡å¼æ— è‡ªå®šä¹‰å»¶è¿Ÿï¼‰
      if: (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.mode == 'è‡ªåŠ¨' || github.event.inputs.debug_schedule != 'æ— ') && github.event.inputs.custom_delay == ''))
      run: |
        # ç”Ÿæˆ 0 åˆ° 20 ä¹‹é—´çš„éšæœºæ•°ä½œä¸ºå»¶è¿Ÿåˆ†é’Ÿæ•°
        DELAY_MINUTES=$((RANDOM % 21))
        # ç”Ÿæˆ 0 åˆ° 59 ä¹‹é—´çš„éšæœºæ•°ä½œä¸ºå»¶è¿Ÿç§’æ•°
        DELAY_SECONDS=$((RANDOM % 60))
        # è®¡ç®—æ€»å»¶è¿Ÿç§’æ•°
        TOTAL_DELAY=$((DELAY_MINUTES * 60 + DELAY_SECONDS))
        echo "â³ ç”Ÿæˆçš„éšæœºå»¶è¿Ÿï¼š${DELAY_MINUTES} åˆ†é’Ÿ ${DELAY_SECONDS} ç§’"
        sleep $TOTAL_DELAY
        echo "âœ… å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    - name: â±ï¸ è‡ªå®šä¹‰å»¶è¿Ÿï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.custom_delay != ''
      run: |
        DELAY=${{ github.event.inputs.custom_delay }}
        echo "â³ è‡ªå®šä¹‰å»¶è¿Ÿï¼š${DELAY} åˆ†é’Ÿ"
        sleep $((DELAY * 60))
        echo "âœ… å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    - name: ğŸ² å‘¨éšæœºæ£€æŸ¥
      id: week_random_check
      if: (github.event_name == 'schedule' && github.event.schedule == '0 0 * * sat,sun') || (github.event_name == 'workflow_dispatch' && github.event.inputs.debug_schedule == 'å‘¨éšæœºä»»åŠ¡')
      run: |
        # ç”Ÿæˆ 0 åˆ° 6 ä¹‹é—´çš„éšæœºæ•°
        CHECK=$((RANDOM % 7))
        echo "ğŸ² éšæœºæ•°ï¼š$CHECK (éœ€è¦ç­‰äº0)"
        # å¦‚æœéšæœºæ•°ä¸ç­‰äº 0ï¼Œåˆ™è·³è¿‡å‘¨éšæœºä»»åŠ¡
        if [ $CHECK -ne 0 ]; then
          echo "â­ï¸ è·³è¿‡å‘¨éšæœºä»»åŠ¡"
          echo "skipped=true" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "ğŸ‰ è§¦å‘å‘¨éšæœºä»»åŠ¡"
          echo "skipped=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”¢ ç”Ÿæˆ READ_NUM
      if: steps.week_random_check.outputs.skipped != 'true'
      run: |
        echo "::group::ğŸ”¢ ç”Ÿæˆ READ_NUM"
        echo "=== è§¦å‘äº‹ä»¶åˆ†æ ==="
        echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "è¾“å…¥æ¨¡å¼: ${{ github.event.inputs.mode }}"
        echo "å®šæ—¶è§„åˆ™: ${{ github.event.schedule }}"
        echo "è‡ªå®šä¹‰æ—¶é—´: ${{ github.event.inputs.custom_time }}"
        echo "è‡ªå®šä¹‰å»¶è¿Ÿ: ${{ github.event.inputs.custom_delay }}"
        echo "è°ƒè¯•å®šæ—¶ä»»åŠ¡: ${{ github.event.inputs.debug_schedule }}"

        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œå¤„ç†è°ƒè¯•å®šæ—¶ä»»åŠ¡
          if [[ "${{ github.event.inputs.debug_schedule }}" != "æ— " ]]; then
            case "${{ github.event.inputs.debug_schedule }}" in
              æ™šé—´ä»»åŠ¡)
                SCHEDULE='0 14 * * *'
                ;;
              æ—©é—´ä»»åŠ¡)
                SCHEDULE='0 21 * * 0-4'
                ;;
              åˆé—´ä»»åŠ¡)
                SCHEDULE='40 3 * * 1-5'
                ;;
              å‘¨æœ«ä»»åŠ¡)
                SCHEDULE='0 9 * * sat,sun'
                ;;
              å‘¨éšæœºä»»åŠ¡)
                SCHEDULE='0 0 * * sat,sun'
                ;;
            esac
          else
            SCHEDULE="${{ github.event.schedule }}"
          fi

          # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [[ -n "${{ github.event.inputs.custom_time }}" ]]; then
            # è‹¥ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥äº†è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼Œåˆ™å°†å…¶ä¹˜ä»¥ 2 ä½œä¸º READ_NUM
            NUM=$(( ${{ github.event.inputs.custom_time }} * 2 ))
            echo "ğŸ•¹ï¸ æ‰‹åŠ¨è§¦å‘ | ä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´: ${{ github.event.inputs.custom_time }} åˆ†é’Ÿï¼Œç­‰æ•ˆ READ_NUM: $NUM"
          else
            # æ‰‹åŠ¨è§¦å‘ä½†æœªæä¾›è‡ªå®šä¹‰æ—¶é—´æ—¶ï¼Œæ ¹æ® mode ç”Ÿæˆé»˜è®¤å€¼
            if [[ "${{ github.event.inputs.mode }}" == "æ‰‹åŠ¨" ]]; then
              # æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼Œç”Ÿæˆ 60 åˆ° 120 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              # è¯¥èŒƒå›´ç­‰æ•ˆäº 30 åˆ° 60 åˆ†é’Ÿçš„é˜…è¯»æ—¶é—´
              NUM=$((RANDOM % 61 + 60))
              echo "ğŸ•¹ï¸ æ‰‹åŠ¨æ¨¡å¼ | èŒƒå›´: 60-120 (30-60åˆ†é’Ÿ)"
            else
              # æ‰‹åŠ¨è§¦å‘ è‡ªåŠ¨ æ¨¡å¼æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„ è‡ªåŠ¨ èŒƒå›´
              case "$SCHEDULE" in
                '0 21 * * 0-4')
                  # æ—©é—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 05:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 130 åˆ° 160 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 130))
                  echo "ğŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´: 130-160"
                  ;;
                '40 3 * * 1-5')
                  # åˆé—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 11:40 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 160 åˆ° 190 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 160))
                  echo "ğŸŒ åˆé—´ä»»åŠ¡ | èŒƒå›´: 160-190"
                  ;;
                '0 14 * * *')
                  # æ™šé—´ä»»åŠ¡ï¼ˆæ¯å¤© 22:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 190))
                  echo "ğŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´: 190-220"
                  ;;
                '0 9 * * sat,sun')
                  # å‘¨æœ«ä»»åŠ¡ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ 17:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 190))
                  echo "ğŸ‰ å‘¨æœ«ä»»åŠ¡ | èŒƒå›´: 190-220"
                  ;;
                '0 0 * * sat,sun')
                  # å‘¨éšæœºä»»åŠ¡ï¼ˆå‘¨æœ« 08:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 120 åˆ° 180 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 61 + 120))
                  echo "ğŸ° å‘¨éšæœºä»»åŠ¡ | èŒƒå›´: 120-180"
                  ;;
                *)
                  # æœªçŸ¥è§¦å‘ç±»å‹ï¼Œå¯ç”¨å®‰å…¨é»˜è®¤å€¼ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 190))
                  echo "âš ï¸ æœªçŸ¥è§¦å‘ç±»å‹ | å¯ç”¨å®‰å…¨é»˜è®¤å€¼: 190-220"
                  ;;
              esac
            fi
          fi
        else
          # è‡ªåŠ¨è§¦å‘ï¼ˆscheduleï¼‰æ—¶ï¼ŒæŒ‰åŸé€»è¾‘ç”Ÿæˆ
          SCHEDULE="${{ github.event.schedule }}"
          case "$SCHEDULE" in
            '0 21 * * 0-4')
              # æ—©é—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 05:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 130 åˆ° 160 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 130))
              echo "ğŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´: 130-160"
              ;;
            '40 3 * * 1-5')
              # åˆé—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 11:40 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 160 åˆ° 190 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 160))
              echo "ğŸŒ åˆé—´ä»»åŠ¡ | èŒƒå›´: 160-190"
              ;;
            '0 14 * * *')
              # æ™šé—´ä»»åŠ¡ï¼ˆæ¯å¤© 22:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 190))
              echo "ğŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´: 190-220"
              ;;
            '0 9 * * sat,sun')
              # å‘¨æœ«ä»»åŠ¡ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ 17:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 190))
              echo "ğŸ‰ å‘¨æœ«ä»»åŠ¡ | èŒƒå›´: 190-220"
              ;;
            '0 0 * * sat,sun')
              # å‘¨éšæœºä»»åŠ¡ï¼ˆå‘¨æœ« 08:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 120 åˆ° 180 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 61 + 120))
              echo "ğŸ° å‘¨éšæœºä»»åŠ¡ | èŒƒå›´: 120-180"
              ;;
            *)
              # æœªçŸ¥è§¦å‘ç±»å‹ï¼Œå¯ç”¨å®‰å…¨é»˜è®¤å€¼ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 190))
              echo "âš ï¸ æœªçŸ¥è§¦å‘ç±»å‹ | å¯ç”¨å®‰å…¨é»˜è®¤å€¼: 190-220"
              ;;
          esac
        fi

        echo "âœ… æœ€ç»ˆ READ_NUM: $NUM (ç­‰æ•ˆ $((NUM / 2)) åˆ†é’Ÿ)"
        # å°† READ_NUM å†™å…¥ç¯å¢ƒå˜é‡
        echo "READ_NUM=$NUM" >> $GITHUB_ENV
        echo "::endgroup::"

    - name: ğŸ“š æ˜¾ç¤ºä¹¦ç±ä¿¡æ¯
      if: steps.week_random_check.outputs.skipped != 'true'
      run: |
        python config.py | grep -E 'ğŸ“š ä¹¦ç±æ˜ å°„è¡¨|ğŸ“– å¯ç”¨ä¹¦ç± b å€¼|ğŸ¯ é€‰å®šä¹¦ç±'

    - name: ğŸš€ æ‰§è¡Œä¸»ç¨‹åº
      if: steps.week_random_check.outputs.skipped != 'true'
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        echo "=== æ‰§è¡Œå‚æ•° ==="
        echo "READ_NUM: ${{ env.READ_NUM }}"
        # æ‰§è¡Œä¸»ç¨‹åº    
